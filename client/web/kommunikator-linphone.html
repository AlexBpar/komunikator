<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.2/prototype.js"></script>

<link rel="stylesheet" type="text/css" href="kommunikator.css" />

<script type="text/javascript">

var mainMenu = ['phone', 'setup'];
var activeTab = 'phone';
var registered = false;

function init() {
	if (window.voip) return;
	var voip = window.voip = $('linphonePlugin');

	// Add event listeners
	for(var i in eventHandlers) voip.addEventListener(i, eventHandlers[i], false);
}

function setStatus(status) {
	$('status').innerHTML = status;
}

function tabActivate(tab) {
	var c;
	
	saveSettings();

	for (c = 0; c < mainMenu.length; c++) {
		$(mainMenu[c] + 'Tab').style.display = 'none';
		$(mainMenu[c] + 'MenuItem').className = '';
	}
	
	$(tab + 'Tab').style.display = 'block';
	$(tab + 'MenuItem').className = 'selected';
}

function connectionButton() {
	if (registered) {
		// Handle disconnect routing
	} else {
		var sipID = localStorage.getItem('sipID');
		var password = localStorage.getItem('password');

		// Initialize linphone
		voip.start();
		voip.setSIPID('sip:' + sipID, '', password);
	}
}

function saveSettings() {
	var frm = $('frmLinphoneSetup');
	
	var sipID = frm.sipid.value;
	var password = frm.password.value;
	
	localStorage.setItem('sipID', sipID);
	localStorage.setItem('password', password);
}

function setRegistered(rbool) {
	setRegistered(rbool, false);
}

function setRegistered(rbool, disabled) {
	registered = rbool;
	$('connect').disabled = disabled
	if (registered) {
		$('connect').value = 'Disconnect';
	} else {
		$('connect').value = 'Connect';
	}
}

function call() {
	var callee = $('frmLinphone').callee.value;

	$('callInfo').style.display = 'block';
	$('what').innerHTML = "Calling " + callee.escapeHTML();
	window.voip.call(callee);
	setHookButton('terminate');
}

function setHookButton(state) {
	var button = $('callHook');
	
	if (state == 'terminate') {
		button.value = 'Terminate';
		button.onclick = function() {
			window.voip.terminate();	
		};
	} else if (state == 'accept') {
		button.value = 'Answer';
		button.onclick = function() {
			window.voip.accept();
			setHookButton('terminate');
		};
	}
}


// Define event handlers
var eventHandlers = {
	AuthInfoRequested: function(realm, username) {
		console.log('Auth info required for', username, 'on', realm);
	},
  
	// Message received
	Message: function(from, msg) {
		console.log("new message from", from, ":", msg);
	},
  
	Status: function(msg) {
		console.log("linphone status:", msg);
	},

	Log: function(message) {
		console.log('plugin log: ' + message);
	},
	
	URL: function(something, url) {
		console.log('linphone url: ' + something + ', ' + url);
	},

	// State changes	
	GlobalStateChanged: function(state, message) {
		console.log("linphone global state (" + state + '): ' + message);
	},
	
	CallStateChanged: function(state, message) {
		console.log('call state (' + state + '): ' + message);
	},
	
	// New call
	Call: function(caller, autoAnswerEnabled) {
		console.log("new call from", caller);
		
		$('what').innerHTML = "Incoming call from " + caller.escapeHTML();
		setHookButton('accept');
		$('callInfo').style.display = 'block';
	},
  
	HangUp: function(caller) {
		console.log("terminate call from", caller);
		$('callInfo').style.display = 'none';
	},
  
	CallConnected: function(caller) {
		console.log('Call connected: ' + caller);
		$('callInfo').style.display = 'block';
		$('what').innerHTML = 'Talking to ' + caller.escapeHTML();
		setHookButton('terminate');
	},
	
	CallError: function(message) {
		console.log("call error: " + message);
		setStatus(message);
		$('callInfo').style.display = 'none';	
	},
	
	RegistrationStateChanged: function(state, address, message) {
		console.log('Registration: state=' + state + ', address=' + address + '. ' + message);
	},
	
	RegistrationProgress: function(address, message) {
		setStatus('Connecting to ' + address);
		setRegistered(false, true);
	},
	
	RegistrationOK: function(address, message) {
		setStatus('Connected!');
		setRegistered(true);
	},
	
	RegistrationFailed: function(address, message) {
		setStatus('Failed to connect to ' + address);
		setRegistered(false);
	},
	
	RegistrationCleared: function(address, message) {
		setStatus('Disconnected from ' + address);
		setRegistered(false);
	}
};
</script>


</head>
<body onload="init();">

<object type="application/x-linphone" id="linphonePlugin" width="0" height="0"> </object>

<div id="mainWindow">

<div id="menu">
	<span id="phoneMenuItem" class="selected" onclick="tabActivate('phone');">Phone</span>
	<span id="setupMenuItem" onclick="tabActivate('setup');">Setup</span>
</div>

<div id="status"></div>

<div id="phoneTab" style="display: block;">
	<form id="frmLinphone">
		<input type="button" class="button" id="connect" onclick="connectionButton();" value="Connect" />
		<p>
			<input type="text" name="callee" value="test@172.17.2.24" />
			<input type="button" class="button" onclick="call();" value="Call" />
		</p>
	</form>

	<p id="callInfo" style="display: none;">
		<strong>Call info</strong><br />
		<span id="what"></span><br />
		<input type="button" id="callHook" class="button" value="" />
	</p>


</div>

<div id="setupTab" style="display: none;">
	<form id="frmLinphoneSetup">
		<table width="100%">
			<tr>
				<td width="30%">SIP ID</td>
				<td width="70%"><input type="text" name="sipid" value="test2@172.17.2.24" /></td>
			</tr>
			<tr>
				<td>Password</td>
				<td><input type="password" name="password" value="test2" /></td>
			</tr>
		</table>
	</form>
</div>

</div>


</body>
</html>